<!-- WeMD 编辑器页面 -->
<div class="wemd-container" 
     data-controller="wemd-editor image-upload history-panel"
     data-wemd-editor-themes-value="<%= @themes.to_json(only: [:id, :name, :css]) %>"
     data-history-panel-current-document-id-value="<%= @document.friendly_id %>"
     data-action="trigger-image-upload@window->image-upload#selectFile 
                  image-upload:uploaded->wemd-editor#handleImageUploaded">
  <%= form_with model: @document, class: "h-full", data: { wemd_editor_target: "form", turbo: false } do |f| %>
    
    <!-- Header -->
    <header class="wemd-header">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:gap-4">
        <!-- Top Row: Icons + Title (Mobile & Desktop) -->
        <div class="flex items-center gap-4 flex-1">
          <!-- History Panel Toggle -->
          <button type="button" 
                  class="text-muted-foreground hover:text-foreground transition-colors flex-shrink-0"
                  data-action="click->history-panel#toggle"
                  title="文章目录">
            <%= lucide_icon "folder", class: "w-5 h-5" %>
          </button>
          
          <!-- New Document Button -->
          <%= link_to new_document_path, 
                      class: "text-muted-foreground hover:text-foreground transition-colors flex-shrink-0",
                      title: "新建文章",
                      data: { turbo: false } do %>
            <%= lucide_icon "plus", class: "w-5 h-5" %>
          <% end %>
          
          <div class="flex-1 min-w-0">
            <%= f.text_field :title, 
                placeholder: "无标题文档", 
                class: "text-xl font-semibold bg-transparent border-none focus:outline-none w-full",
                data: { wemd_editor_target: "titleInput" } %>
          </div>

          <!-- Save Status Indicator (Desktop only) -->
          <div class="hidden md:flex items-center gap-2">
            <span class="text-sm text-muted-foreground whitespace-nowrap" data-wemd-editor-target="saveStatus">已保存</span>
          </div>
        </div>

        <!-- Bottom Row: Action Buttons (Mobile: stacked, Desktop: inline) -->
        <div class="flex items-center gap-2 flex-wrap md:flex-nowrap">
          <!-- Save Status Indicator (Mobile only) -->
          <div class="flex md:hidden items-center gap-2 w-full justify-end">
            <span class="text-xs text-muted-foreground" data-wemd-editor-target="saveStatus">已保存</span>
          </div>
          
          <!-- Theme Selector -->
          <%= f.select :theme_id,
              options_from_collection_for_select(@themes, :id, :name, @document.theme_id),
              {},
              class: "select-theme text-sm md:text-base w-auto",
              data: { wemd_editor_target: "themeSelect", action: "change->wemd-editor#updatePreview" } %>

          <!-- Copy to WeChat Button (hidden for new documents) -->
          <button type="button" 
                  class="btn-primary text-sm md:text-base whitespace-nowrap <%= 'hidden' if @document.new_record? %>"
                  data-wemd-editor-target="copyButton"
                  data-action="click->wemd-editor#copyToWechat">
            <%= lucide_icon "copy", class: "w-4 h-4 md:w-5 md:h-5" %>
            <span>复制到微信</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Workspace -->
    <main class="wemd-main">
      <div class="wemd-workspace">
        <!-- Editor Pane -->
        <div class="wemd-editor-pane">
          <div class="wemd-toolbar">
            <!-- 撤销/重做按钮 -->
            <button type="button" class="wemd-tool-btn" data-action="click->wemd-editor#undo" title="撤销 (Ctrl+Z)">
              <%= lucide_icon "undo", class: "w-4 h-4" %>
            </button>
            <button type="button" class="wemd-tool-btn" data-action="click->wemd-editor#redo" title="重做 (Ctrl+Shift+Z)">
              <%= lucide_icon "redo", class: "w-4 h-4" %>
            </button>
            
            <div class="wemd-toolbar-divider"></div>
            
            <button type="button" class="wemd-tool-btn" data-action="click->wemd-editor#insertBold" title="加粗">
              <%= lucide_icon "bold", class: "w-4 h-4" %>
            </button>
            <button type="button" class="wemd-tool-btn hidden md:inline-flex" data-action="click->wemd-editor#insertItalic" title="斜体">
              <%= lucide_icon "italic", class: "w-4 h-4" %>
            </button>
            
            <!-- 标题下拉菜单 -->
            <div class="wemd-heading-dropdown wemd-dropdown-container">
              <button type="button" class="wemd-tool-btn" data-action="click->wemd-editor#toggleHeadingMenu" title="标题">
                <%= lucide_icon "heading", class: "w-4 h-4" %>
              </button>
              <div class="wemd-heading-menu wemd-dropdown-menu hidden">
                <button type="button" class="wemd-dropdown-item" 
                        data-action="click->wemd-editor#insertHeadingLevel"
                        data-prefix="# "
                        data-placeholder="一级标题">
                  <%= lucide_icon "heading-1", class: "w-3.5 h-3.5 mr-2" %>
                  <span>一级标题</span>
                </button>
                <button type="button" class="wemd-dropdown-item" 
                        data-action="click->wemd-editor#insertHeadingLevel"
                        data-prefix="## "
                        data-placeholder="二级标题">
                  <%= lucide_icon "heading-2", class: "w-3.5 h-3.5 mr-2" %>
                  <span>二级标题</span>
                </button>
                <button type="button" class="wemd-dropdown-item" 
                        data-action="click->wemd-editor#insertHeadingLevel"
                        data-prefix="### "
                        data-placeholder="三级标题">
                  <%= lucide_icon "heading-3", class: "w-3.5 h-3.5 mr-2" %>
                  <span>三级标题</span>
                </button>
                <button type="button" class="wemd-dropdown-item" 
                        data-action="click->wemd-editor#insertHeadingLevel"
                        data-prefix="#### "
                        data-placeholder="四级标题">
                  <%= lucide_icon "heading-4", class: "w-3.5 h-3.5 mr-2" %>
                  <span>四级标题</span>
                </button>
              </div>
            </div>
            
            <div class="wemd-toolbar-divider hidden md:block"></div>
            <button type="button" class="wemd-tool-btn hidden md:inline-flex" data-action="click->wemd-editor#insertLink" title="链接">
              <%= lucide_icon "link", class: "w-4 h-4" %>
            </button>
            <button type="button" class="wemd-tool-btn" data-action="click->wemd-editor#insertImage" title="图片">
              <%= lucide_icon "image", class: "w-4 h-4" %>
            </button>
            <button type="button" class="wemd-tool-btn hidden md:inline-flex" data-action="click->wemd-editor#insertCode" title="代码块">
              <%= lucide_icon "code", class: "w-4 h-4" %>
            </button>
            
            <div class="wemd-toolbar-divider"></div>
            
            <!-- 列表下拉菜单 -->
            <div class="wemd-list-dropdown wemd-dropdown-container">
              <button type="button" class="wemd-tool-btn" data-action="click->wemd-editor#toggleListMenu" title="列表">
                <%= lucide_icon "list", class: "w-4 h-4" %>
              </button>
              <div class="wemd-list-menu wemd-dropdown-menu hidden">
                <button type="button" class="wemd-dropdown-item" 
                        data-action="click->wemd-editor#insertListType"
                        data-prefix="- "
                        data-placeholder="列表项">
                  <%= lucide_icon "list", class: "w-3.5 h-3.5 mr-2" %>
                  <span>无序列表</span>
                </button>
                <button type="button" class="wemd-dropdown-item" 
                        data-action="click->wemd-editor#insertListType"
                        data-prefix="1. "
                        data-placeholder="列表项">
                  <%= lucide_icon "list-ordered", class: "w-3.5 h-3.5 mr-2" %>
                  <span>有序列表</span>
                </button>
                <button type="button" class="wemd-dropdown-item" 
                        data-action="click->wemd-editor#insertListType"
                        data-prefix="- [ ] "
                        data-placeholder="待办事项">
                  <%= lucide_icon "check-square", class: "w-3.5 h-3.5 mr-2" %>
                  <span>任务列表</span>
                </button>
              </div>
            </div>
            
            <button type="button" class="wemd-tool-btn hidden md:inline-flex" data-action="click->wemd-editor#insertQuote" title="引用">
              <%= lucide_icon "quote", class: "w-4 h-4" %>
            </button>
            
            <div class="wemd-toolbar-divider hidden md:block"></div>
            
            <button type="button" class="wemd-tool-btn hidden md:inline-flex" data-action="click->wemd-editor#insertTable" title="表格">
              <%= lucide_icon "table", class: "w-4 h-4" %>
            </button>
          </div>

          <%= f.text_area :content,
              class: "wemd-editor-textarea",
              placeholder: "开始编写您的 Markdown 文档...",
              data: { 
                wemd_editor_target: "editor",
                action: "input->wemd-editor#updatePreview"
              } %>
        </div>

        <!-- Preview Pane -->
        <div class="wemd-preview-pane">
          <div class="wemd-preview-header">
            <h3 class="text-sm font-semibold text-muted-foreground">实时预览</h3>
          </div>
          
          <div class="wemd-preview-content" data-wemd-editor-target="preview previewContent">
            <!-- Markdown 预览内容将通过 JS 渲染到这里 -->
          </div>
        </div>
      </div>
    </main>
  <% end %>

  <!-- History Panel Sidebar -->
  <aside class="history-sidebar fixed top-16 left-0 bottom-0 w-96 bg-surface border-r border-border shadow-xl 
                transform -translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col"
         data-history-panel-target="sidebar">
    <!-- Sidebar Header -->
    <div class="flex items-center justify-between border-b border-border bg-surface" style="padding: 1rem 3.5rem;">
      <h2 class="text-lg font-semibold text-foreground flex items-center gap-2">
        <%= lucide_icon "folder", class: "w-5 h-5" %>
        文章目录
      </h2>
      <div class="flex items-center gap-2">
        <button type="button"
                class="text-muted-foreground hover:text-foreground transition-colors"
                data-action="click->history-panel#close"
                title="关闭">
          <%= lucide_icon "x", class: "w-5 h-5" %>
        </button>
      </div>
    </div>

    <!-- Search Bar -->
    <div class="border-b border-border bg-surface" style="padding: 1rem 3.5rem;">
      <div class="relative">
        <%= lucide_icon "search", class: "absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground" %>
        <input type="text"
               placeholder="搜索文章..."
               class="w-full pl-10 pr-4 py-2 bg-muted border border-border rounded-lg 
                      text-sm focus:outline-none focus:ring-2 focus:ring-primary"
               data-history-panel-target="searchInput"
               data-action="input->history-panel#search" />
      </div>
    </div>

    <!-- History List -->
    <div class="flex-1 overflow-y-auto" style="padding: 1rem 3.5rem;">
      <!-- Loading State -->
      <div class="text-center py-12" data-history-panel-target="loadingState">
        <p class="text-muted-foreground">正在加载...</p>
      </div>

      <!-- Empty State -->
      <div class="text-center py-12 hidden" data-history-panel-target="emptyState">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-muted mb-4">
          <%= lucide_icon "file-text", class: "w-8 h-8 text-muted-foreground" %>
        </div>
        <p class="text-muted-foreground">暂无文章</p>
      </div>

      <!-- List Container -->
      <div class="space-y-3 hidden" data-history-panel-target="list">
        <!-- 文章列表项将通过 JS 渲染到这里 -->
      </div>
    </div>
  </aside>

  <!-- Sidebar Overlay -->
  <div class="fixed inset-0 bg-black/50 z-40 hidden opacity-0 transition-opacity duration-300"
       data-action="click->history-panel#close"></div>

  <!-- Hidden file input for image upload -->
  <input type="file" 
         accept="image/*" 
         class="hidden" 
         data-image-upload-target="fileInput"
         data-action="change->image-upload#handleFileSelect" />
</div>

<!-- 加载必要的 CSS -->
<style id="theme-styles">
  <%= raw @theme.css if @theme %>
</style>

<style>
/* History Sidebar Styles */
.history-sidebar {
  width: 400px;
  max-width: 90vw;
}

.history-entry {
  transition: all 0.2s ease;
}

.history-entry:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}
</style>
